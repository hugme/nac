#!/bin/bash

# Set the variables
. $(cat varset)

use_base_functions

##########################################################
# set your date
EXPIRE_YEAR=$(($(date +%y)+2))

export CONTENT_STRING=$(dd bs=1024 count=100 2>/dev/null)
[ -z "$QUERY_STRING" ] && QUERY_STRING=$CONTENT_STRING

for X in ${QUERY_STRING//&/ }; do
	case $X in
		ROLE=*) ROLE=${X#*=};;
		RID=*) RID=${X#*=};;
		HOSTNAME=*) HOSTNAME=${X#*=};;
		DID=*) DID=${X#*=};;
	esac
done

echo "Content-type: text/plain"
echo

################################################################################
## If they give you a hostname instead of a role, find out what the
## role is.
################################################################################

[[ -z $ROLE && -n $HOSTNAME ]] && {
 IFS="|" read ROLE _ <<<$(echo "select role from servers where name='$HOSTNAME'"| sql_query)
 [[ -z $ROLE ]] && {

cat << EOF
###########################################################
### Warning: That hostname or role could not be found
###########################################################
EOF
exit 0

 }
}

################################################################################
## Get the services from the role. Error if the role wasn't found
################################################################################
IFS="|" read SERVICES _ <<<$(echo "select services from role where name='$ROLE'" | sql_query)
[[ -z $SERVICES ]] && {
cat << EOF
###########################################################
### Warning: The role was not found or there are no
### services associated with it.
###########################################################
EOF
exit 0
}

REQ="nrpe='on' and nrpe_name is not null and nrpe_command is not null and ("
unset i
for X in $SERVICES ; do
 [[ -n $i ]] && REQ="$REQ or"
 REQ="$REQ service_id=$X"
 i=0
done
REQ="$REQ )"

cat << EOF
###########################################################
### This file is autogenerated and should not be edited ###
###########################################################
EOF
while IFS="|" read N_NAME N_COMMAND ; do
 echo "command[$N_NAME]=$N_COMMAND"
done< <(echo "select nrpe_name,nrpe_command from services where $REQ" | sql_query)
exit 0
